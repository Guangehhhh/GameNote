## Ocean
---

---
  - 水体模拟技术大体可以分为三类
    - 第一类，叠加不同的，随机周期函数，构成水体表面
      - 多用来，表现波涛起伏海面，暂且称为波形叠加法
    - 第二类，使用波动方程，或者近似公式，来表现局部的水波
      - 多用于，表现物体与水面互动产生的涟漪
    - 第三类，使用预渲染的Flow Map表现复杂的水流运动
      - 多用于，模拟涡流等，难于实时计算的非线性运动
# Gerstner波
  - 波形叠加故名思义就是将很多个不同周期，不同振幅的周期函数叠加在一起
    - 但在水体模拟中我们使用的基础波形并不是正弦和余弦波
      - 而是一种叫做Gerstner波的特殊波形
    - Gerstner波和余弦波的差别，用一幅简单的图就能说明了
      - Gerstner波构造起来非常容易，用2d的波形作说明
        - 只要在y轴上取cos(t)，再在x轴上添加一个相对应的sin(2t)位移就能得到
        - Gerstner波的“收紧”部分就是绿色箭头所指的sin(2t)
      - Gerstner波还有一种很多人不知道的变换，就是斜切波形
        - 大家一定知道cos(x)如果把x换成x^i，波形会向一个方向倾斜
        - 图中的波形是cos(2*pi*x^2)，可以看出波形明显向右边“倾斜”
        - 如果Gerstner的x和y坐标都加上这种倾斜，就能得到斜切Gerstner波
          - 用来模拟涌向海岸边的潮水将很多个不同波长，不同振幅的Gerstner波叠加在一起
          - 加上一些随机值，就能得到下图这种看起来很复杂的海面效果
      - 如果需要更为复杂的波形叠加，可以使用逆向fft算法
        - 因为fft的效率还不错，一幅512x512的频谱图对应262144个波形，同时叠加这么多波形，能给海面带来非常高的复杂度
      - 计算白浪
        - 用雅可比绝对值计算白浪出现的位置
        - 白浪是水面激烈碰撞涌起的白色泡沫
        - 在水面模拟的时候可以认为在Gerstner波最尖锐的部分会产生白浪
        - 这个尖锐的部分可以用雅可比绝对值来计算

# 波动方程
  - 波动方程的变形wave particles。
    - 这是07年的一片siggraph论文，虽然老了点，但效果很好
    - 神秘海域4的水面模拟就是用的这个技术。

# Wave Particles
  - Wave Particles的想法其实很直接
    - 波动方程太简单了，波动方程的波之间不会相互影响 ，只会在碰到边界的时候反弹一下
      - 那干脆别算波动方程了，把波都看成一个粒子，遇到边界会反弹，在移动的时候能量会衰减
      - 再按照Gerstner波的样子变形出来，就是一个小鼓包
  - 如果你要制造一个扇面形状的波，发射一扇小鼓包
    - 如果想制造一圈的波纹，就发射一圈小鼓包，随便你
  - 但是随着小鼓包的移动，他们本来是团结在一起的，却渐渐散开了
    - 这也好办，小鼓包可以随着移动而增殖，如果跑的距离太远了，就一个变三个
  - 到这里就可以看出wave particles的最大优点是直观易懂，容易控制，想要生成什么样的波纹都可以控制
    - 这也是神秘海域4开发时使用这个技术的主要原因。

  - 不过wave particles对于开发人员来说还是挺有难度的
    - 尤其是作者在论文中很多细节地方都没写清楚
    - 我在做的时候遇到了不少麻烦
  - 这里就随便提两点吧
    - 第一是上面提到的斜切波形的问题，论文中能实现出漂亮的浪头形状
      - 但文章中只用了普通的Gerstner波。基本不可能做出来这种效果
    - 另一个问题是怎么把粒子渲染成位移图，文章中根本就没提
      - 只提到以每个粒子为中心，渲染出一个Gerstner波形状
      - 难道要每个粒子都向位移图渲染一个圆的范围吗，这个大的计算量怎么可能做到实时啊
    - 实际的做法是先渲染出粒子的位置，然后分别在x方向和y方向做一次模糊filter
      - filter的核就是Gerstner波的公式，这样比起双向filter的消耗还要小，真是个值得记住的小技巧
    - 当然wave particles比起波动方程还是有局限性的
      - 比如像From Dust那种上帝游戏，会增加和减少水量，还是用波动方程计算水的流动比较容易
